import imaplib

from django.contrib.auth.models import Group
from django.test import TestCase
from django.db import models
from guardian.shortcuts import get_perms

from unittest.mock import patch, MagicMock
from datetime import datetime, timedelta

from gmail_messages.service_inbox import InboxMessages
from gmail_messages.tasks import save_message
from mothers.models import Mother

Mother: models


class SaveMessageTestCase(TestCase):
    def setUp(self):
        self.email_user = "example@gmail.com"
        self.email_pass = "testpassword"
        self.email_server = "imap.gmail.com"
        self.email_chapter = 'inbox'

        self.date = datetime.today()
        self.search_criteria = (f'SINCE "{self.date.strftime("%d-%b-%Y")}" '
                                f'BEFORE "{(self.date + timedelta(days=1)).strftime("%d-%b-%Y")}"')

        self.translation_dict = {
            'ФИО': 'name',
            'Телефон': 'number',
            'Город проживания': 'residence',
            'Программа': 'program',
            'Ваш рост и вес': 'height_and_weight',
            'Есть ли склонность ко вредным привычкам?': 'bad_habits',
            'Делали Вам кесарево? Сколько раз?': 'caesarean',
            'Возраст родных детей': 'children_age',
            'Ваш возраст': 'age',
            'Гражданство': 'citizenship',
            'Группа крови': 'blood',
            'Семейное положение': 'maried',
        }
        self.data = [(b'11 (RFC822 {21709}',
                      b'Delivered-To: alina.rodion123@gmail.com\r\nReceived: by 2002:a05:7412:248c:b0:ee:9298:3d7 with SMTP id t12csp1053561rdh;\r\n        Mon, 20 Nov 2023 05:27:13 -0800 (PST)\r\nX-Received: by 2002:a17:90b:4f45:b0:27c:f016:49a2 with SMTP id pj5-20020a17090b4f4500b0027cf01649a2mr5046090pjb.7.1700486832887;\r\n        Mon, 20 Nov 2023 05:27:12 -0800 (PST)\r\nARC-Seal: i=1; a=rsa-sha256; t=1700486832; cv=none;\r\n        d=google.com; s=arc-20160816;\r\n        b=aYhrDmQjkQnY6ycT1SHzsISGpjJMLoD3pG5YKQgTlY3LDoLgps+19gH99IMZHnBrdz\r\n         UOV2DYmrX4UgoGhub7msLEhWKBBYJejlNP3BCvNDZ3DwRX3GhMbXWmAVjFz0yVMS+peZ\r\n         GlnJ7ixO+ZzO7+g4Y3e7ybVgJEa+dYChiI3a1tEhXcOl+WnhwjnFo9zE3wnDD3Ff00EU\r\n         7E0tZeErQaTyWQo1LuJcx01Zn2TYzHoWOZ/tRoUN7s4kRrKXnCEDsUYJXAyQ1a0/+zo2\r\n         o2tm3hRnqoOn398kPGUpp0IDyVGxc2+63J8IHw7z1ISutd5avL3e4R1kgNoSVp7CvVoS\r\n         G1HQ==\r\nARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;\r\n        h=to:subject:message-id:date:from:mime-version:dkim-signature;\r\n        bh=W9L7sGkj+Z3LjLBHE6qe/zbcJ/MqjOwJhxsDQOO8z6Q=;\r\n        fh=fSmO5cQiNTc96DoxgQ3XLsbqLB/wdfYBDOgv4xSxxuA=;\r\n        b=Dr6CFsEWZ9TkXfgPHO1Dc7WG7n6vvnI5oWRsXwl23V/Dn1rEdmCV/vo/bkzF3i1fVj\r\n         qbiyUYdhIUZ/1c1KT70uZJcCviViikba9xU0l6itmk8D1TTUFujBixw4wkz75G6jR3kK\r\n         D+OEZwmUahb6wpN4iz6gPO9RC3EyYb2QUgcajBCz6NtcIIx8biY9odLgGp+9E47dvF7l\r\n         3dsNRKw6nZ0Zy47vZlV59m45hJQddsqSLHqaazEDmEdAQl+rzyq2+Yh18xgecIXZrLgG\r\n         mi3RB/D3wq4EByDr3ObNfQxFEscVvXPlsmquN8u3BNZuaGU8Faih999g7REU8/eEM3eN\r\n         AvEg==\r\nARC-Authentication-Results: i=1; mx.google.com;\r\n       dkim=pass header.i=@gmail.com header.s=20230601 header.b="i7xA/gwZ";\r\n       spf=pass (google.com: domain of rodion.maulenov@gmail.com designates 209.85.220.41 as permitted sender) smtp.mailfrom=rodion.maulenov@gmail.com;\r\n       dmarc=pass (p=NONE sp=QUARANTINE dis=NONE) header.from=gmail.com\r\nReturn-Path: <rodion.maulenov@gmail.com>\r\nReceived: from mail-sor-f41.google.com (mail-sor-f41.google.com. [209.85.220.41])\r\n        by mx.google.com with SMTPS id s19-20020a17090aad9300b00267ec49db7dsor4009967pjq.1.2023.11.20.05.27.12\r\n        for <alina.rodion123@gmail.com>\r\n        (Google Transport Security);\r\n        Mon, 20 Nov 2023 05:27:12 -0800 (PST)\r\nReceived-SPF: pass (google.com: domain of rodion.maulenov@gmail.com designates 209.85.220.41 as permitted sender) client-ip=209.85.220.41;\r\nAuthentication-Results: mx.google.com;\r\n       dkim=pass header.i=@gmail.com header.s=20230601 header.b="i7xA/gwZ";\r\n       spf=pass (google.com: domain of rodion.maulenov@gmail.com designates 209.85.220.41 as permitted sender) smtp.mailfrom=rodion.maulenov@gmail.com;\r\n       dmarc=pass (p=NONE sp=QUARANTINE dis=NONE) header.from=gmail.com\r\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;\r\n        d=gmail.com; s=20230601; t=1700486832; x=1701091632; dara=google.com;\r\n        h=to:subject:message-id:date:from:mime-version:from:to:cc:subject\r\n         :date:message-id:reply-to;\r\n        bh=W9L7sGkj+Z3LjLBHE6qe/zbcJ/MqjOwJhxsDQOO8z6Q=;\r\n        b=i7xA/gwZorQuWSYD+39hHMtOzelVRZH4nXWV8JjtWv82y1mmDmhuIl4G7hUOeb3Nu+\r\n         cyY83UpCb1mG6OWG5iX000v8xP6EgKrqGTt96YQT/HBqm7LKzP9z9c/aP7mrLAUde4yy\r\n         EFzYRevKPZHIH3LPkqQZ8vsQEigCNCsJ81cx/by+Fl9occlSa5GbhWpDLOIsKHwoIj6x\r\n         +9g8c5xr6SMEyikF/EsTEO4e+ByGOwQzowG/5QokGn4bVf1351uC1YT6yV2OvfXU32Kx\r\n         0PJPJ+bUDjCAOB+eMH46oXrYrDyWkh/E/EHBpkJF5N9Us9jVZ/9tHsxnBzDZp+qRTSi7\r\n         fgNg==\r\nX-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;\r\n        d=1e100.net; s=20230601; t=1700486832; x=1701091632;\r\n        h=to:subject:message-id:date:from:mime-version:x-gm-message-state\r\n         :from:to:cc:subject:date:message-id:reply-to;\r\n        bh=W9L7sGkj+Z3LjLBHE6qe/zbcJ/MqjOwJhxsDQOO8z6Q=;\r\n        b=E+l9LWOetlFvVfXLaBchdTikvI+t01FJV2vSLcz6H+wzLwmSrRfro6sGWq/DExz3Xb\r\n         a3WRSaWRF07t9KH/rfvN8iQNTgHhaiBPXAsvgInZ8z6Dqdr8+Mudk3fVAix1oBUo+Qi4\r\n         7r4oKAyquWyrmliWPhq9N9M3O8rv1qTTU3S0j5vKGSTHmxjtBtL3boJYknvc6HMvTSS5\r\n         FDSlWaJAtETyLq0EoaDRjjYKSUKe0GKDrQo8Vvfx/2I/cGyAATjIqvGls7wKaud1igcW\r\n         Jb2ZyACAI6uNhfwXO8svd7q1XqXM05V5ULoPg1TLw+7KCGvWMcI/CPhWs1nVNrnBERQo\r\n         /dhQ==\r\nX-Gm-Message-State: AOJu0YwQL4q1pJVxRY3DI9IpqDd4wMOvnGnoSxlv04bEgg+0zT+VfvHx\r\n\tvpHhA+B5jn3g9T0+aNNJPZKxCD5qO318SRAXS8OM5XB4CTvz5w==\r\nX-Google-Smtp-Source: AGHT+IHGgTpnZ8M4ia/CYauCSA8YZ1BjCQei1SCKRra5sSGL6A8XZHAZAEG5COJ1W/q7QXRhL7Q3ZngsscBf9Sv0aWM=\r\nX-Received: by 2002:a17:90b:1d8c:b0:285:1aff:7eea with SMTP id\r\n pf12-20020a17090b1d8c00b002851aff7eeamr3157282pjb.47.1700486832089; Mon, 20\r\n Nov 2023 05:27:12 -0800 (PST)\r\nMIME-Version: 1.0\r\nFrom: =?UTF-8?B?0KDQvtC00LjQvtC9INCc0LDRg9C70LXQvdC+0LI=?= <rodion.maulenov@gmail.com>\r\nDate: Mon, 20 Nov 2023 15:27:01 +0200\r\nMessage-ID: <CA+uaQBMW9nMkgp+qJTmXSt8fdbixNpOPqqKXJMXewCZGDyN6mg@mail.gmail.com>\r\nSubject: =?UTF-8?B?0JDQvdC60LXRgtCwINGBINGB0LDQudGC0LA=?=\r\nTo: alina.rodion123@gmail.com\r\nContent-Type: multipart/alternative; boundary="000000000000926e0f060a9571ab"\r\n\r\n--000000000000926e0f060a9571ab\r\nContent-Type: text/plain; charset="UTF-8"\r\nContent-Transfer-Encoding: base64\r\n\r\n0JHRi9C70LAg0LfQsNC/0L7Qu9C90LXQvdCwINCw0L3QutC10YLQsCDQvdCwINGB0YPRgNGA0L7Q\r\ns9Cw0YLQvdGD0Y4g0LzQsNGC0Ywv0LTQvtC90L7RgNGB0YLQstC+INGP0LnRhtC10LrQu9C10YLQ\r\nvtC6DQrQn9C+0LbQsNC70YPQudGB0YLQsCwg0L7QsdGA0LDQsdC+0YLQsNC50YLQtSDQt9Cw0Y/Q\r\nstC60YMNCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t\r\nLS0NCtCk0JjQniAtIFR1cmRpcXVsb3ZhIEd1bGNoZWhyYQ0K0J/QvtGH0YLQsCAtIFtlbWFpbC02\r\nMDddDQrQotC10LvQtdGE0L7QvSAtICs5OTg5NDU3ODc4NDkNCtCT0L7RgNC+0LQg0L/RgNC+0LbQ\r\nuNCy0LDQvdC40Y8gLSBEdXN0bGlrDQrQn9GA0L7Qs9GA0LDQvNC80LAgLSDQodGD0YDRgNC+0LPQ\r\nsNGCINC+0L3QsNC70LjQuioNCtCS0LDRiCDRgNC+0YHRgiDQuCDQstC10YEgLSAxNjcsIDEwNGtn\r\nDQrQldGB0YLRjCDQu9C4INGB0LrQu9C+0L3QvdC+0YHRgtGMINC60L4g0LLRgNC10LTQvdGL0Lwg\r\n0L/RgNC40LLRi9GH0LrQsNC8PyAtDQrQlNC10LvQsNC70Lgg0JLQsNC8INC60LXRgdCw0YDQtdCy\r\n0L4/INCh0LrQvtC70YzQutC+INGA0LDQtz8gLSBZdXENCtCS0L7Qt9GA0LDRgdGCINGA0L7QtNC9\r\n0YvRhSDQtNC10YLQtdC5IC0gOCA3IG95bGlrDQrQktCw0Ygg0LLQvtC30YDQsNGB0YIgLSAzMw0K\r\n0JPRgNCw0LbQtNCw0L3RgdGC0LLQviAtIFV6YmVraXN0b24NCtCT0YDRg9C/0L/QsCDQutGA0L7Q\r\nstC4IC0gMQ0K0KHQtdC80LXQudC90L7QtSDQv9C+0LvQvtC20LXQvdC40LUgLSBZYXhzaGkNCg==\r\n--000000000000926e0f060a9571ab\r\nContent-Type: text/html; charset="UTF-8"\r\nContent-Transfer-Encoding: quoted-printable\r\n\r\n<div dir=3D"ltr"><div dir=3D"ltr"><span style=3D"color:rgb(34,34,34);font-f=\r\namily:Arial,Helvetica,sans-serif;font-size:small;font-style:normal;font-var=\r\niant-ligatures:normal;font-variant-caps:normal;font-weight:400;letter-spaci=\r\nng:normal;text-align:start;text-indent:0px;text-transform:none;word-spacing=\r\n:0px;white-space:normal;background-color:rgb(255,255,255);text-decoration-s=\r\ntyle:initial;text-decoration-color:initial;display:inline;float:none">=D0=\r\n=91=D1=8B=D0=BB=D0=B0 =D0=B7=D0=B0=D0=BF=D0=BE=D0=BB=D0=BD=D0=B5=D0=BD=D0=\r\n=B0 =D0=B0=D0=BD=D0=BA=D0=B5=D1=82=D0=B0 =D0=BD=D0=B0 =D1=81=D1=83=D1=80=D1=\r\n=80=D0=BE=D0=B3=D0=B0=D1=82=D0=BD=D1=83=D1=8E =D0=BC=D0=B0=D1=82=D1=8C/=D0=\r\n=B4=D0=BE=D0=BD=D0=BE=D1=80=D1=81=D1=82=D0=B2=D0=BE =D1=8F=D0=B9=D1=86=D0=\r\n=B5=D0=BA=D0=BB=D0=B5=D1=82=D0=BE=D0=BA</span><br style=3D"color:rgb(34,34,=\r\n34);font-family:Arial,Helvetica,sans-serif;font-size:small;font-style:norma=\r\nl;font-variant-ligatures:normal;font-variant-caps:normal;font-weight:400;le=\r\ntter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;wo=\r\nrd-spacing:0px;white-space:normal;background-color:rgb(255,255,255);text-de=\r\ncoration-style:initial;text-decoration-color:initial"><span style=3D"color:=\r\nrgb(34,34,34);font-family:Arial,Helvetica,sans-serif;font-size:small;font-s=\r\ntyle:normal;font-variant-ligatures:normal;font-variant-caps:normal;font-wei=\r\nght:400;letter-spacing:normal;text-align:start;text-indent:0px;text-transfo=\r\nrm:none;word-spacing:0px;white-space:normal;background-color:rgb(255,255,25=\r\n5);text-decoration-style:initial;text-decoration-color:initial;display:inli=\r\nne;float:none">=D0=9F=D0=BE=D0=B6=D0=B0=D0=BB=D1=83=D0=B9=D1=81=D1=82=D0=B0=\r\n, =D0=BE=D0=B1=D1=80=D0=B0=D0=B1=D0=BE=D1=82=D0=B0=D0=B9=D1=82=D0=B5 =D0=B7=\r\n=D0=B0=D1=8F=D0=B2=D0=BA=D1=83</span><br style=3D"color:rgb(34,34,34);font-=\r\nfamily:Arial,Helvetica,sans-serif;font-size:small;font-style:normal;font-va=\r\nriant-ligatures:normal;font-variant-caps:normal;font-weight:400;letter-spac=\r\ning:normal;text-align:start;text-indent:0px;text-transform:none;word-spacin=\r\ng:0px;white-space:normal;background-color:rgb(255,255,255);text-decoration-=\r\nstyle:initial;text-decoration-color:initial"><span style=3D"color:rgb(34,34=\r\n,34);font-family:Arial,Helvetica,sans-serif;font-size:small;font-style:norm=\r\nal;font-variant-ligatures:normal;font-variant-caps:normal;font-weight:400;l=\r\netter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;w=\r\nord-spacing:0px;white-space:normal;background-color:rgb(255,255,255);text-d=\r\necoration-style:initial;text-decoration-color:initial;display:inline;float:=\r\nnone">------------------------------</span><span style=3D"color:rgb(34,34,3=\r\n4);font-family:Arial,Helvetica,sans-serif;font-size:small;font-style:normal=\r\n;font-variant-ligatures:normal;font-variant-caps:normal;font-weight:400;let=\r\nter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;wor=\r\nd-spacing:0px;white-space:normal;background-color:rgb(255,255,255);text-dec=\r\noration-style:initial;text-decoration-color:initial;display:inline;float:no=\r\nne">----------------------</span><br style=3D"color:rgb(34,34,34);font-fami=\r\nly:Arial,Helvetica,sans-serif;font-size:small;font-style:normal;font-varian=\r\nt-ligatures:normal;font-variant-caps:normal;font-weight:400;letter-spacing:=\r\nnormal;text-align:start;text-indent:0px;text-transform:none;word-spacing:0p=\r\nx;white-space:normal;background-color:rgb(255,255,255);text-decoration-styl=\r\ne:initial;text-decoration-color:initial"><span style=3D"color:rgb(34,34,34)=\r\n;font-family:Arial,Helvetica,sans-serif;font-size:small;font-style:normal;f=\r\nont-variant-ligatures:normal;font-variant-caps:normal;font-weight:400;lette=\r\nr-spacing:normal;text-align:start;text-indent:0px;text-transform:none;word-=\r\nspacing:0px;white-space:normal;background-color:rgb(255,255,255);text-decor=\r\nation-style:initial;text-decoration-color:initial;display:inline;float:none=\r\n">=D0=A4=D0=98=D0=9E - Turdiqulova Gulchehra</span><br style=3D"color:rgb(3=\r\n4,34,34);font-family:Arial,Helvetica,sans-serif;font-size:small;font-style:=\r\nnormal;font-variant-ligatures:normal;font-variant-caps:normal;font-weight:4=\r\n00;letter-spacing:normal;text-align:start;text-indent:0px;text-transform:no=\r\nne;word-spacing:0px;white-space:normal;background-color:rgb(255,255,255);te=\r\nxt-decoration-style:initial;text-decoration-color:initial"><span style=3D"c=\r\nolor:rgb(34,34,34);font-family:Arial,Helvetica,sans-serif;font-size:small;f=\r\nont-style:normal;font-variant-ligatures:normal;font-variant-caps:normal;fon=\r\nt-weight:400;letter-spacing:normal;text-align:start;text-indent:0px;text-tr=\r\nansform:none;word-spacing:0px;white-space:normal;background-color:rgb(255,2=\r\n55,255);text-decoration-style:initial;text-decoration-color:initial;display=\r\n:inline;float:none">=D0=9F=D0=BE=D1=87=D1=82=D0=B0 - [email-607]</span><br =\r\nstyle=3D"color:rgb(34,34,34);font-family:Arial,Helvetica,sans-serif;font-si=\r\nze:small;font-style:normal;font-variant-ligatures:normal;font-variant-caps:=\r\nnormal;font-weight:400;letter-spacing:normal;text-align:start;text-indent:0=\r\npx;text-transform:none;word-spacing:0px;white-space:normal;background-color=\r\n:rgb(255,255,255);text-decoration-style:initial;text-decoration-color:initi=\r\nal"><span style=3D"color:rgb(34,34,34);font-family:Arial,Helvetica,sans-ser=\r\nif;font-size:small;font-style:normal;font-variant-ligatures:normal;font-var=\r\niant-caps:normal;font-weight:400;letter-spacing:normal;text-align:start;tex=\r\nt-indent:0px;text-transform:none;word-spacing:0px;white-space:normal;backgr=\r\nound-color:rgb(255,255,255);text-decoration-style:initial;text-decoration-c=\r\nolor:initial;display:inline;float:none">=D0=A2=D0=B5=D0=BB=D0=B5=D1=84=D0=\r\n=BE=D0=BD - +998945787849</span><br style=3D"color:rgb(34,34,34);font-famil=\r\ny:Arial,Helvetica,sans-serif;font-size:small;font-style:normal;font-variant=\r\n-ligatures:normal;font-variant-caps:normal;font-weight:400;letter-spacing:n=\r\normal;text-align:start;text-indent:0px;text-transform:none;word-spacing:0px=\r\n;white-space:normal;background-color:rgb(255,255,255);text-decoration-style=\r\n:initial;text-decoration-color:initial"><span style=3D"color:rgb(34,34,34);=\r\nfont-family:Arial,Helvetica,sans-serif;font-size:small;font-style:normal;fo=\r\nnt-variant-ligatures:normal;font-variant-caps:normal;font-weight:400;letter=\r\n-spacing:normal;text-align:start;text-indent:0px;text-transform:none;word-s=\r\npacing:0px;white-space:normal;background-color:rgb(255,255,255);text-decora=\r\ntion-style:initial;text-decoration-color:initial;display:inline;float:none"=\r\n>=D0=93=D0=BE=D1=80=D0=BE=D0=B4 =D0=BF=D1=80=D0=BE=D0=B6=D0=B8=D0=B2=D0=B0=\r\n=D0=BD=D0=B8=D1=8F - Dustlik</span><br style=3D"color:rgb(34,34,34);font-fa=\r\nmily:Arial,Helvetica,sans-serif;font-size:small;font-style:normal;font-vari=\r\nant-ligatures:normal;font-variant-caps:normal;font-weight:400;letter-spacin=\r\ng:normal;text-align:start;text-indent:0px;text-transform:none;word-spacing:=\r\n0px;white-space:normal;background-color:rgb(255,255,255);text-decoration-st=\r\nyle:initial;text-decoration-color:initial"><span style=3D"color:rgb(34,34,3=\r\n4);font-family:Arial,Helvetica,sans-serif;font-size:small;font-style:normal=\r\n;font-variant-ligatures:normal;font-variant-caps:normal;font-weight:400;let=\r\nter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;wor=\r\nd-spacing:0px;white-space:normal;background-color:rgb(255,255,255);text-dec=\r\noration-style:initial;text-decoration-color:initial;display:inline;float:no=\r\nne">=D0=9F=D1=80=D0=BE=D0=B3=D1=80=D0=B0=D0=BC=D0=BC=D0=B0 - =D0=A1=D1=83=\r\n=D1=80=D1=80=D0=BE=D0=B3=D0=B0=D1=82 =D0=BE=D0=BD=D0=B0=D0=BB=D0=B8=D0=BA*<=\r\n/span><br style=3D"color:rgb(34,34,34);font-family:Arial,Helvetica,sans-ser=\r\nif;font-size:small;font-style:normal;font-variant-ligatures:normal;font-var=\r\niant-caps:normal;font-weight:400;letter-spacing:normal;text-align:start;tex=\r\nt-indent:0px;text-transform:none;word-spacing:0px;white-space:normal;backgr=\r\nound-color:rgb(255,255,255);text-decoration-style:initial;text-decoration-c=\r\nolor:initial"><span style=3D"color:rgb(34,34,34);font-family:Arial,Helvetic=\r\na,sans-serif;font-size:small;font-style:normal;font-variant-ligatures:norma=\r\nl;font-variant-caps:normal;font-weight:400;letter-spacing:normal;text-align=\r\n:start;text-indent:0px;text-transform:none;word-spacing:0px;white-space:nor=\r\nmal;background-color:rgb(255,255,255);text-decoration-style:initial;text-de=\r\ncoration-color:initial;display:inline;float:none">=D0=92=D0=B0=D1=88 =D1=80=\r\n=D0=BE=D1=81=D1=82 =D0=B8 =D0=B2=D0=B5=D1=81 - 167, 104kg</span><br style=\r\n=3D"color:rgb(34,34,34);font-family:Arial,Helvetica,sans-serif;font-size:sm=\r\nall;font-style:normal;font-variant-ligatures:normal;font-variant-caps:norma=\r\nl;font-weight:400;letter-spacing:normal;text-align:start;text-indent:0px;te=\r\nxt-transform:none;word-spacing:0px;white-space:normal;background-color:rgb(=\r\n255,255,255);text-decoration-style:initial;text-decoration-color:initial"><=\r\nspan style=3D"color:rgb(34,34,34);font-family:Arial,Helvetica,sans-serif;fo=\r\nnt-size:small;font-style:normal;font-variant-ligatures:normal;font-variant-=\r\ncaps:normal;font-weight:400;letter-spacing:normal;text-align:start;text-ind=\r\nent:0px;text-transform:none;word-spacing:0px;white-space:normal;background-=\r\ncolor:rgb(255,255,255);text-decoration-style:initial;text-decoration-color:=\r\ninitial;display:inline;float:none">=D0=95=D1=81=D1=82=D1=8C =D0=BB=D0=B8 =\r\n=D1=81=D0=BA=D0=BB=D0=BE=D0=BD=D0=BD=D0=BE=D1=81=D1=82=D1=8C =D0=BA=D0=BE =\r\n=D0=B2=D1=80=D0=B5=D0=B4=D0=BD=D1=8B=D0=BC =D0=BF=D1=80=D0=B8=D0=B2=D1=8B=\r\n=D1=87=D0=BA=D0=B0=D0=BC? -</span><br style=3D"color:rgb(34,34,34);font-fam=\r\nily:Arial,Helvetica,sans-serif;font-size:small;font-style:normal;font-varia=\r\nnt-ligatures:normal;font-variant-caps:normal;font-weight:400;letter-spacing=\r\n:normal;text-align:start;text-indent:0px;text-transform:none;word-spacing:0=\r\npx;white-space:normal;background-color:rgb(255,255,255);text-decoration-sty=\r\nle:initial;text-decoration-color:initial"><span style=3D"color:rgb(34,34,34=\r\n);font-family:Arial,Helvetica,sans-serif;font-size:small;font-style:normal;=\r\nfont-variant-ligatures:normal;font-variant-caps:normal;font-weight:400;lett=\r\ner-spacing:normal;text-align:start;text-indent:0px;text-transform:none;word=\r\n-spacing:0px;white-space:normal;background-color:rgb(255,255,255);text-deco=\r\nration-style:initial;text-decoration-color:initial;display:inline;float:non=\r\ne">=D0=94=D0=B5=D0=BB=D0=B0=D0=BB=D0=B8 =D0=92=D0=B0=D0=BC =D0=BA=D0=B5=D1=\r\n=81=D0=B0=D1=80=D0=B5=D0=B2=D0=BE? =D0=A1=D0=BA=D0=BE=D0=BB=D1=8C=D0=BA=D0=\r\n=BE =D1=80=D0=B0=D0=B7? - Yuq</span><br style=3D"color:rgb(34,34,34);font-f=\r\namily:Arial,Helvetica,sans-serif;font-size:small;font-style:normal;font-var=\r\niant-ligatures:normal;font-variant-caps:normal;font-weight:400;letter-spaci=\r\nng:normal;text-align:start;text-indent:0px;text-transform:none;word-spacing=\r\n:0px;white-space:normal;background-color:rgb(255,255,255);text-decoration-s=\r\ntyle:initial;text-decoration-color:initial"><span style=3D"color:rgb(34,34,=\r\n34);font-family:Arial,Helvetica,sans-serif;font-size:small;font-style:norma=\r\nl;font-variant-ligatures:normal;font-variant-caps:normal;font-weight:400;le=\r\ntter-spacing:normal;text-align:start;text-indent:0px;text-transform:none;wo=\r\nrd-spacing:0px;white-space:normal;background-color:rgb(255,255,255);text-de=\r\ncoration-style:initial;text-decoration-color:initial;display:inline;float:n=\r\none">=D0=92=D0=BE=D0=B7=D1=80=D0=B0=D1=81=D1=82 =D1=80=D0=BE=D0=B4=D0=BD=D1=\r\n=8B=D1=85 =D0=B4=D0=B5=D1=82=D0=B5=D0=B9 - 8 7 oylik</span><br style=3D"col=\r\nor:rgb(34,34,34);font-family:Arial,Helvetica,sans-serif;font-size:small;fon=\r\nt-style:normal;font-variant-ligatures:normal;font-variant-caps:normal;font-=\r\nweight:400;letter-spacing:normal;text-align:start;text-indent:0px;text-tran=\r\nsform:none;word-spacing:0px;white-space:normal;background-color:rgb(255,255=\r\n,255);text-decoration-style:initial;text-decoration-color:initial"><span st=\r\nyle=3D"color:rgb(34,34,34);font-family:Arial,Helvetica,sans-serif;font-size=\r\n:small;font-style:normal;font-variant-ligatures:normal;font-variant-caps:no=\r\nrmal;font-weight:400;letter-spacing:normal;text-align:start;text-indent:0px=\r\n;text-transform:none;word-spacing:0px;white-space:normal;background-color:r=\r\ngb(255,255,255);text-decoration-style:initial;text-decoration-color:initial=\r\n;display:inline;float:none">=D0=92=D0=B0=D1=88 =D0=B2=D0=BE=D0=B7=D1=80=D0=\r\n=B0=D1=81=D1=82 - 33</span><br style=3D"color:rgb(34,34,34);font-family:Ari=\r\nal,Helvetica,sans-serif;font-size:small;font-style:normal;font-variant-liga=\r\ntures:normal;font-variant-caps:normal;font-weight:400;letter-spacing:normal=\r\n;text-align:start;text-indent:0px;text-transform:none;word-spacing:0px;whit=\r\ne-space:normal;background-color:rgb(255,255,255);text-decoration-style:init=\r\nial;text-decoration-color:initial"><span style=3D"color:rgb(34,34,34);font-=\r\nfamily:Arial,Helvetica,sans-serif;font-size:small;font-style:normal;font-va=\r\nriant-ligatures:normal;font-variant-caps:normal;font-weight:400;letter-spac=\r\ning:normal;text-align:start;text-indent:0px;text-transform:none;word-spacin=\r\ng:0px;white-space:normal;background-color:rgb(255,255,255);text-decoration-=\r\nstyle:initial;text-decoration-color:initial;display:inline;float:none">=D0=\r\n=93=D1=80=D0=B0=D0=B6=D0=B4=D0=B0=D0=BD=D1=81=D1=82=D0=B2=D0=BE - Uzbekisto=\r\nn</span><br style=3D"color:rgb(34,34,34);font-family:Arial,Helvetica,sans-s=\r\nerif;font-size:small;font-style:normal;font-variant-ligatures:normal;font-v=\r\nariant-caps:normal;font-weight:400;letter-spacing:normal;text-align:start;t=\r\next-indent:0px;text-transform:none;word-spacing:0px;white-space:normal;back=\r\nground-color:rgb(255,255,255);text-decoration-style:initial;text-decoration=\r\n-color:initial"><span style=3D"color:rgb(34,34,34);font-family:Arial,Helvet=\r\nica,sans-serif;font-size:small;font-style:normal;font-variant-ligatures:nor=\r\nmal;font-variant-caps:normal;font-weight:400;letter-spacing:normal;text-ali=\r\ngn:start;text-indent:0px;text-transform:none;word-spacing:0px;white-space:n=\r\normal;background-color:rgb(255,255,255);text-decoration-style:initial;text-=\r\ndecoration-color:initial;display:inline;float:none">=D0=93=D1=80=D1=83=D0=\r\n=BF=D0=BF=D0=B0 =D0=BA=D1=80=D0=BE=D0=B2=D0=B8 - 1</span><br style=3D"color=\r\n:rgb(34,34,34);font-family:Arial,Helvetica,sans-serif;font-size:small;font-=\r\nstyle:normal;font-variant-ligatures:normal;font-variant-caps:normal;font-we=\r\night:400;letter-spacing:normal;text-align:start;text-indent:0px;text-transf=\r\norm:none;word-spacing:0px;white-space:normal;background-color:rgb(255,255,2=\r\n55);text-decoration-style:initial;text-decoration-color:initial"><span styl=\r\ne=3D"color:rgb(34,34,34);font-family:Arial,Helvetica,sans-serif;font-size:s=\r\nmall;font-style:normal;font-variant-ligatures:normal;font-variant-caps:norm=\r\nal;font-weight:400;letter-spacing:normal;text-align:start;text-indent:0px;t=\r\next-transform:none;word-spacing:0px;white-space:normal;background-color:rgb=\r\n(255,255,255);text-decoration-style:initial;text-decoration-color:initial;d=\r\nisplay:inline;float:none">=D0=A1=D0=B5=D0=BC=D0=B5=D0=B9=D0=BD=D0=BE=D0=B5 =\r\n=D0=BF= D0=BE=D0=BB=D0=BE=D0=B6=D0=B5=D0=BD=D0=B8=D0=B5 - Yaxshi</span></div=\r\n></div>\r\n\r\n--000000000000926e0f060a9571ab--\r\n'),
                     b')']

    @patch('gmail_messages.service_inbox.imaplib.IMAP4_SSL')
    def test_login_gmail(self, mock_imap):
        inbox = InboxMessages()
        inbox.login_gmail(self.email_user, self.email_pass, self.email_server, self.email_chapter)

        mock_imap.assert_called_once_with(self.email_server)
        mock_imap.return_value.login.assert_called_once_with(self.email_user, self.email_pass)
        mock_imap.return_value.select.assert_called_once_with(self.email_chapter)
        self.assertEqual(inbox.mail, mock_imap.return_value)

    @patch('gmail_messages.service_inbox.imaplib.IMAP4_SSL')
    def test_save_message_when_all_new_messages(self, mock_imap):
        mock_mail_instance = MagicMock()
        mock_mail_instance.search.return_value = ('OK', [b'12 13 14'])
        mock_mail_instance.fetch.side_effect = [('OK', self.data), ('OK', self.data), ('OK', self.data)]
        mock_imap.return_value = mock_mail_instance

        save_message()

        mothers = Mother.objects.all()
        self.assertEqual(len(mothers.filter(stage__isnull=False)), 3)

        group = Group.objects.get(name='primary_stage')
        for obj in Mother.objects.all():
            self.assertEqual(len(get_perms(group, obj)), 2)

        self.assertEqual(len(mothers), 3)
        self.assertEqual(Mother.objects.first().id, 12)
        self.assertEqual(len(Mother.objects.first().condition_set.all()), 1)

    @patch('gmail_messages.service_inbox.imaplib.IMAP4_SSL')
    def test_save_message_when_from_all_some_messages_repeat(self, mock_imap):
        Mother.objects.create(id=12, name="Bober")
        Mother.objects.create(id=13)
        mock_mail_instance = MagicMock()
        mock_mail_instance.search.return_value = ('OK', [b'12 13 14 15'])
        mock_mail_instance.fetch.side_effect = [('OK', self.data), ('OK', self.data), ('OK', self.data),
                                                ('OK', self.data)]
        mock_imap.return_value = mock_mail_instance

        mothers = Mother.objects.all()
        self.assertEqual(len(mothers.filter(stage__isnull=False)), 0)
        self.assertEqual(len(mothers), 2)

        save_message()

        self.assertEqual(len(Mother.objects.all()), 4)
        self.assertNotEquals(Mother.objects.first().name, Mother.objects.last().name)

        mothers = Mother.objects.all()
        self.assertEqual(len(mothers.filter(stage__isnull=False)), 2)

        group = Group.objects.get(name='primary_stage')
        for obj in mothers.filter(stage__isnull=False):
            self.assertEqual(len(get_perms(group, obj)), 2)

    @patch('gmail_messages.service_inbox.imaplib.IMAP4_SSL')
    def test_login_and_extract_messages(self, mock_imap):
        mock_mail_instance = MagicMock()
        mock_mail_instance.login.side_effect = imaplib.IMAP4.error("Simulated login error")

        mock_imap.return_value = mock_mail_instance

        # Now, when you call login_gmail, it should raise the simulated IMAP4.error
        with self.assertRaises(imaplib.IMAP4.error):
            inbox = InboxMessages()
            inbox.login_gmail(self.email_user, self.email_pass, self.email_server, self.email_chapter)
